// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =====================================
// Core User Tables
// =====================================

model UsersExtended {
  id                   String    @id @default(uuid()) @db.Uuid
  email                String    @unique
  firstName            String    @map("first_name")
  lastName             String    @map("last_name")
  dateOfBirth          DateTime? @map("date_of_birth") @db.Date
  gender               String?
  recoveryEmail        String?   @map("recovery_email")
  recoveryPhone        String?   @map("recovery_phone")
  isSuspended          Boolean   @default(false) @map("is_suspended")
  lastLogin            DateTime? @map("last_login") @db.Timestamptz
  failedLoginAttempts  Int       @default(0) @map("failed_login_attempts")
  lockedUntil          DateTime? @map("locked_until") @db.Timestamptz
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  customDomains        CustomDomain[]
  activityLogs         ActivityLog[]
  mailboxMetadata      MailboxMetadata?
  supportTickets       SupportTicket[]
  userGroupMembers     UserGroupMember[]

  @@map("users_extended")
}

model AdminUser {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  roleId       String?   @map("role_id") @db.Uuid
  isActive     Boolean   @default(true) @map("is_active")
  createdBy    String?   @map("created_by") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  lastLogin    DateTime? @map("last_login") @db.Timestamptz

  // Relations
  role                 AdminRole?        @relation("AdminUserRole", fields: [roleId], references: [id])
  createdByAdmin       AdminUser?        @relation("AdminUserCreatedBy", fields: [createdBy], references: [id])
  createdAdmins        AdminUser[]       @relation("AdminUserCreatedBy")
  userTemplates        UserTemplate[]
  scheduledActions     ScheduledAction[]
  bulkImportLogs       BulkImportLog[]
  userGroupMembers     UserGroupMember[]

  @@map("admin_users")
}

// =====================================
// Authentication & Security Tables
// =====================================

model PasswordReset {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  otpCode   String   @map("otp_code")
  otpType   String   @map("otp_type")
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([email])
  @@index([expiresAt])
  @@map("password_resets")
}

model LoginActivity {
  id            String   @id @default(uuid()) @db.Uuid
  userEmail     String   @map("user_email")
  loginTime     DateTime @default(now()) @map("login_time") @db.Timestamptz
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  success       Boolean
  failureReason String?  @map("failure_reason")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([userEmail])
  @@index([loginTime(sort: Desc)])
  @@index([success])
  @@map("login_activity")
}

model SignupAttempt {
  id               String   @id @default(uuid()) @db.Uuid
  ipAddress        String   @map("ip_address")
  emailAttempted   String   @map("email_attempted")
  hcaptchaVerified Boolean  @default(false) @map("hcaptcha_verified")
  honeypotFilled   Boolean  @default(false) @map("honeypot_filled")
  success          Boolean  @default(false)
  failureReason    String?  @map("failure_reason")
  userAgent        String?  @map("user_agent")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([ipAddress])
  @@index([createdAt])
  @@index([ipAddress, createdAt])
  @@index([emailAttempted])
  @@map("signup_attempts")
}

// =====================================
// Admin Roles & Permissions
// =====================================

model AdminRole {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  description  String?
  permissions  Json     @default("{}")
  isSystemRole Boolean  @default(false) @map("is_system_role")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  adminUsers AdminUser[] @relation("AdminUserRole")

  @@map("admin_roles")
}

// =====================================
// Audit & Logging
// =====================================

model AuditLog {
  id              String   @id @default(uuid()) @db.Uuid
  actionType      String   @map("action_type")
  adminEmail      String   @map("admin_email")
  targetUserEmail String?  @map("target_user_email")
  details         Json?
  ipAddress       String?  @map("ip_address")
  timestamp       DateTime @default(now()) @db.Timestamptz

  @@index([adminEmail])
  @@index([timestamp])
  @@map("audit_logs")
}

model ActivityLog {
  id           String        @id @default(uuid()) @db.Uuid
  userId       String?       @map("user_id") @db.Uuid
  activityType String        @map("activity_type")
  description  String?
  ipAddress    String?       @map("ip_address")
  userAgent    String?       @map("user_agent")
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user UsersExtended? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("activity_logs")
}

// =====================================
// Mailbox & Storage
// =====================================

model MailboxMetadata {
  id         String    @id @default(uuid()) @db.Uuid
  email      String    @unique
  userId     String?   @unique @map("user_id") @db.Uuid
  quotaBytes BigInt    @default(0) @map("quota_bytes")
  usageBytes BigInt    @default(0) @map("usage_bytes")
  lastSynced DateTime  @default(now()) @map("last_synced") @db.Timestamptz
  lastSync   DateTime? @map("last_sync") @db.Timestamptz

  // Relations
  user UsersExtended? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@map("mailbox_metadata")
}

// =====================================
// Domain Management
// =====================================

model MailDomain {
  id          String   @id @default(uuid()) @db.Uuid
  domain      String   @unique
  isPrimary   Boolean  @default(false) @map("is_primary")
  isActive    Boolean  @default(true) @map("is_active")
  description String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([domain])
  @@map("mail_domains")
}

model CustomDomain {
  id                 String    @id @default(uuid()) @db.Uuid
  domain             String    @unique
  userId             String?   @map("user_id") @db.Uuid
  verificationStatus String    @default("pending") @map("verification_status")
  verificationCode   String?   @map("verification_code")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  verifiedAt         DateTime? @map("verified_at") @db.Timestamptz

  // Relations
  user UsersExtended? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([verificationStatus])
  @@map("custom_domains")
}

// =====================================
// Email Aliases
// =====================================

model EmailAlias {
  id                 String   @id @default(uuid()) @db.Uuid
  aliasAddress       String   @unique @map("alias_address")
  targetAddresses    String[] @map("target_addresses")
  isDistributionList Boolean  @default(false) @map("is_distribution_list")
  description        String?
  active             Boolean  @default(true)
  createdBy          String?  @map("created_by")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([aliasAddress])
  @@index([active])
  @@map("email_aliases")
}

// =====================================
// Announcements & System
// =====================================

model Announcement {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  message     String
  targetGroup String    @default("all") @map("target_group")
  priority    String    @default("normal")
  published   Boolean   @default(false)
  publishedAt DateTime? @map("published_at") @db.Timestamptz
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([published])
  @@index([createdAt(sort: Desc)])
  @@map("announcements")
}

model SystemSetting {
  id           String   @id @default(uuid()) @db.Uuid
  settingKey   String   @unique @map("setting_key")
  settingValue Json     @map("setting_value")
  description  String?
  updatedBy    String?  @map("updated_by")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("system_settings")
}

// =====================================
// Support Tickets
// =====================================

model SupportTicket {
  id              String    @id @default(uuid()) @db.Uuid
  ticketType      String    @map("ticket_type")
  userEmail       String    @map("user_email")
  userId          String?   @map("user_id") @db.Uuid
  status          String    @default("pending")
  priority        String    @default("normal")
  subject         String?
  message         String?
  description     String?
  resolutionNotes String?   @map("resolution_notes")
  assignedTo      String?   @map("assigned_to")
  resolvedBy      String?   @map("resolved_by")
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user UsersExtended? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([userEmail])
  @@index([createdAt(sort: Desc)])
  @@map("support_tickets")
}

// =====================================
// Sending Limits & Abuse Prevention
// =====================================

model SendingTier {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  displayName  String   @map("display_name")
  dailyLimit   Int      @map("daily_limit")
  hourlyLimit  Int      @map("hourly_limit")
  priceMonthly Decimal  @default(0) @map("price_monthly") @db.Decimal(10, 2)
  features     Json     @default("[]")
  isActive     Boolean  @default(true) @map("is_active")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  emailSendingLimits EmailSendingLimit[]

  @@map("sending_tiers")
}

model EmailSendingLimit {
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  tierId             String?   @map("tier_id") @db.Uuid
  tierName           String    @default("free") @map("tier_name")
  dailyLimit         Int       @default(50) @map("daily_limit")
  hourlyLimit        Int       @default(10) @map("hourly_limit")
  emailsSentToday    Int       @default(0) @map("emails_sent_today")
  emailsSentThisHour Int       @default(0) @map("emails_sent_this_hour")
  lastResetDate      DateTime  @default(now()) @map("last_reset_date") @db.Date
  lastResetHour      DateTime  @default(now()) @map("last_reset_hour") @db.Timestamptz
  isSendingEnabled   Boolean   @default(true) @map("is_sending_enabled")
  customLimitReason  String?   @map("custom_limit_reason")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tier SendingTier? @relation(fields: [tierId], references: [id])

  @@index([userId])
  @@index([tierName])
  @@map("email_sending_limits")
}

model EmailSendLog {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  recipientEmail  String   @map("recipient_email")
  recipientCount  Int      @default(1) @map("recipient_count")
  subject         String?
  status          String   @default("sent")
  failureReason   String?  @map("failure_reason")
  blockedReason   String?  @map("blocked_reason")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  sentAt          DateTime @default(now()) @map("sent_at") @db.Timestamptz
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId])
  @@index([sentAt(sort: Desc)])
  @@index([userId, sentAt(sort: Desc)])
  @@index([status])
  @@map("email_send_logs")
}

model SendingLimitViolation {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  violationType    String    @map("violation_type")
  attemptedCount   Int       @map("attempted_count")
  limitAtTime      Int       @map("limit_at_time")
  violationDetails Json      @default("{}") @map("violation_details")
  actionTaken      String    @default("logged") @map("action_taken")
  adminNotes       String?   @map("admin_notes")
  isResolved       Boolean   @default(false) @map("is_resolved")
  resolvedAt       DateTime? @map("resolved_at") @db.Timestamptz
  resolvedBy       String?   @map("resolved_by")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("sending_limit_violations")
}

// =====================================
// User Templates & Groups
// =====================================

model UserTemplate {
  id               String    @id @default(uuid()) @db.Uuid
  name             String    @unique
  description      String?
  quotaBytes       BigInt    @default(5368709120) @map("quota_bytes")
  permissions      Json      @default("{}")
  isSystemTemplate Boolean   @default(false) @map("is_system_template")
  createdBy        String?   @map("created_by") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  createdByAdmin AdminUser? @relation(fields: [createdBy], references: [id])

  @@map("user_templates")
}

model UserGroup {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?
  color       String   @default("blue")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  members UserGroupMember[]

  @@map("user_groups")
}

model UserGroupMember {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  addedAt   DateTime @default(now()) @map("added_at") @db.Timestamptz
  addedBy   String?  @map("added_by") @db.Uuid

  // Relations
  user       UsersExtended? @relation(fields: [userId], references: [id])
  group      UserGroup      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  addedByAdmin AdminUser?   @relation(fields: [addedBy], references: [id])

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("user_group_members")
}

// =====================================
// Scheduled Actions & Bulk Operations
// =====================================

model ScheduledAction {
  id           String    @id @default(uuid()) @db.Uuid
  actionType   String    @map("action_type")
  targetType   String    @map("target_type")
  targetIds    Json      @default("[]") @map("target_ids")
  scheduledFor DateTime  @map("scheduled_for") @db.Timestamptz
  status       String    @default("pending")
  actionData   Json      @default("{}") @map("action_data")
  createdBy    String?   @map("created_by") @db.Uuid
  executedAt   DateTime? @map("executed_at") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  createdByAdmin AdminUser? @relation(fields: [createdBy], references: [id])

  @@index([status])
  @@index([scheduledFor])
  @@index([actionType])
  @@map("scheduled_actions")
}

model BulkImportLog {
  id                String   @id @default(uuid()) @db.Uuid
  filename          String
  totalRows         Int      @default(0) @map("total_rows")
  successfulImports Int      @default(0) @map("successful_imports")
  failedImports     Int      @default(0) @map("failed_imports")
  errorDetails      Json     @default("[]") @map("error_details")
  importedBy        String?  @map("imported_by") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  importedByAdmin AdminUser? @relation(fields: [importedBy], references: [id])

  @@map("bulk_import_logs")
}
